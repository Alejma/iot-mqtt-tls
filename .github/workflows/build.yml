name: Build IoT MQTT TLS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install PlatformIO
      run: |
        pip install platformio
        platformio platform install espressif32
    
    - name: Build with secrets
      env:
        # Configuración de ubicación
        COUNTRY: ${{ secrets.COUNTRY }}
        STATE: ${{ secrets.STATE }}
        CITY: ${{ secrets.CITY }}
        
        # Configuración del servidor MQTT
        MQTT_SERVER: ${{ secrets.MQTT_SERVER }}
        MQTT_PORT: ${{ secrets.MQTT_PORT }}
        MQTT_USER: ${{ secrets.MQTT_USER }}
        MQTT_PASSWORD: ${{ secrets.MQTT_PASSWORD }}
        
        # Configuración de WiFi
        WIFI_SSID: ${{ secrets.WIFI_SSID }}
        WIFI_PASSWORD: ${{ secrets.WIFI_PASSWORD }}
        
        # Certificado raíz
        ROOT_CA: ${{ secrets.ROOT_CA }}
      run: |
        platformio run -e esp32dev
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: firmware
        path: .pio/build/esp32dev/firmware.bin